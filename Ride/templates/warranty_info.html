{% extends "base.html" %}

{% block title %}
Mongoori - Warranty List
{% endblock %}

{% block content %}
<div class="col-12">
    <div class="card card-primary card-outline mb-4">
        <!-- Card header -->
        <div class="card-header">
            <div class="card-title">Warranty Information</div>
        </div>
        
        <div class="card-body">
        <!--div for Table-->
            <table id = "warrantyTable" class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>VIN</th>
                        <th>Model</th>
                        <th>Year</th>
                        <th>Plate</th>
                        <th>Type</th>
                        <th>Expire Date</th>
                        <th>Expire Miles</th>
                        <th>Status</th>
                    </tr>
                </thead>

                <tbody>
                    {% for w in warranties %}
                    <tr data-id="{{w.vehicle_id}}" data-type="{{w.warranty_type}}">
                        <td>{{w.vin}}</td>
                        <td>{{w.model}}</td>
                        <td>{{w.model_year}}</td>
                        <td>{{w.plate_number}}</td>
                        <td class = "edit-type">{{w.warranty_type}}</td>
                        <td class = "edit-date">{{w.expire_date or '-'}}</td>
                        <td class = "edit-miles">{{w.expire_miles or '-'}}</td>
                        <td>{{w.status}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!--div for Table end-->

    </div>
</div>

<!-- Modal -->
<div class = "modal fade" id="editFieldModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Edit Field</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="saveFieldBtn" class="btn btn-primary btn-sm">Save</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {
        $.fn.dataTable.ext.order['warranty-type-order'] = function(sttings, col){
            const orderMap = {
                'Basic Vehicle' : 1,
                'Battery' : 2,
                'Drive Unit': 3
            };

            return this.api().column(col, { order: 'index'}).data().map(type => orderMap[type] || 99);
        };

        const table = $('#warrantyTable').DataTable({
            responsive: false,
            autoWidth: false,
            scrollX: true,

            order: [[3, 'asc'], [4, 'asc'], [5, 'asc']],

            columnDefs: [
                {targets: 3, orderDataType: 'warranty-type-order'},
                {targets: [0,1,2,3], visible: false}
            ],

            rowGroup: {
                dataSrc: 0,
                startRender: function (rows, group){
                    const model = rows.data().pluck(1)[0];
                    const year = rows.data().pluck(2)[0];
                    const plate = rows.data().pluck(3)[0];
                    const count = rows.count();

                    return $('<tr/>').append(`
                        <td colspan="7" class = "bg-light fw-bold">
                            <div>VIN: ${group}</div>
                            <div class = "text-muted small ms-3">
                                ${model} (${year}) - Plate: ${plate}}
                            </div>
                        </td>    
                    `);
                }
            }
            });
        });
</script>


<script src="{{ url_for('static', filename='warranty_edit.js') }}"></script>

{% endblock %}